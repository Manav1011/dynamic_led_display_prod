{% extends "base.html" %}
{% load static %}
{% block title %}
  Analytics
{% endblock title %}
{% block content %}
<script>
     //Globals
    var ws_rs232 = null
    var ws_rs485 = null    
</script>
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Analytics</h1>        
    </div>
    <!-- Content Row -->
    <div class="row">

        <!-- Earnings (Monthly) Card Example -->
        <div class="col-xl-12 col-md-12 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Connections</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="connection_label">None</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type = "text/javascript">
            async function reviewConnections(Connections){
                let connection_label = document.getElementById('connection_label')
                let ConnectionString = ''
                for(let i in Connections){                    
                    if(Connections[i] === true){
                        ConnectionString += `${i} | `
                    }
                }
                if (ConnectionString.length == 0) ConnectionString = 'No Device Connected'
                connection_label.textContent = ConnectionString
            }
            var Connections = {
                RS232:false,
                RS485:false
            }
            async function WebSocketTestRS232() {
                rs232_rtc_el = document.getElementById('rs232_rtc')
                rs232_humidity_val_el = document.getElementById('rs232_humidity_val')
                rs232_speed_val_el = document.getElementById('rs232_speed_val')
                rs232_sr_val_el = document.getElementById('rs232_sr_val')
                rs232_temp_val_el = document.getElementById('rs232_temp_val')
                
                rs232_humidity_progress_el = document.getElementById('rs232_humidity_progress')
                rs232_speed_progress_el = document.getElementById('rs232_speed_progress')
                rs232_sr_progress_el = document.getElementById('rs232_sr_progress')
                rs232_temp_progress_el = document.getElementById('rs232_temp_progress')

               if ("WebSocket" in window) {
                  // Let us open a web socket
                  ws_rs232 = new WebSocket("ws://192.168.29.18:8000/serial_communication_rs232/");
                   
                  ws_rs232.onopen = async function() {
                    Connections.RS232 = true
                    await reviewConnections(Connections)
                    ws_rs232.send(JSON.stringify({            
                        client:'dashboard',
                        page:'analytics'
                    }));
                  };
                   
                  ws_rs232.onmessage = async function (evt) {                     
                     let received_msg = JSON.parse(evt.data);
                     console.log(received_msg)
                     if(received_msg.rs232_plot){
                        var xValues =    Object.keys(received_msg.rs232_plot);
                        var yValues =  Object.keys(received_msg.rs232_plot).map(key => received_msg.rs232_plot[key]); 
                        var barColors = ["red", "green","blue","orange"];
                        new Chart("rs232Canvas", {
                            type: "line",
                            data: {
                              labels: xValues,
                              datasets: [{
                                fill: false,
                                lineTension: 0,
                                backgroundColor: "rgba(0,0,255,1.0)",
                                borderColor: "rgba(0,0,255,0.1)",
                                data: yValues
                              }]
                            },
                            options: {
                              legend: {display: false},
                              scales: {
                               // yAxes: [{ticks: {min: -1, max:1}}],
                              }
                            }
                          });
                     }
                     if (received_msg.client == 'producer' && received_msg.action == 'stream' && received_msg.mode == 'serial_rs232'){
                        let rs232_rtc = received_msg.data.RTC
                        let rs232_humidity_val = received_msg.data.AvgeHum
                        let rs232_speed_val = received_msg.data.AvgeSpeed
                        let rs232_sr_val = received_msg.data.AvgeSr
                        let rs232_temp_val = received_msg.data.AvgeTemp

                        rs232_rtc_el.textContent = rs232_rtc
                        rs232_humidity_val_el.textContent = rs232_humidity_val
                        rs232_speed_val_el.textContent = rs232_speed_val
                        rs232_sr_val_el.textContent = rs232_sr_val
                        rs232_temp_val_el.textContent = rs232_temp_val

                        rs232_humidity_progress_el.style.width = `${(rs232_humidity_val + 1) * 50}%`
                        rs232_speed_progress_el.style.width = `${(rs232_speed_val + 1) * 50}%`
                        rs232_sr_progress_el.style.width = `${(rs232_sr_val + 1) * 50}%`
                        rs232_temp_progress_el.style.width = `${(rs232_temp_val + 1) * 50}%`

                     }
                  };
                   
                  ws_rs232.onclose = async function() {
                    Connections.RS232 = false
                    await reviewConnections()
                    console.log("Connection Closed")                     
                  };
               } else {                  
                  alert("WebSocket NOT supported by your Browser!");
               }
            }
            async function WebSocketTestRS485() {
                rs485_rtc_el = document.getElementById('rs485_rtc')
                rs485_humidity_val_el = document.getElementById('rs485_humidity_val')
                rs485_speed_val_el = document.getElementById('rs485_speed_val')
                rs485_sr_val_el = document.getElementById('rs485_sr_val')
                rs485_temp_val_el = document.getElementById('rs485_temp_val')
                
                rs485_humidity_progress_el = document.getElementById('rs485_humidity_progress')
                rs485_speed_progress_el = document.getElementById('rs485_speed_progress')
                rs485_sr_progress_el = document.getElementById('rs485_sr_progress')
                rs485_temp_progress_el = document.getElementById('rs485_temp_progress')
               
                if ("WebSocket" in window) {
                   // Let us open a web socket
                   ws_rs485 = new WebSocket("ws://192.168.29.18:8000/serial_communication_rs485/");
                    
                   ws_rs485.onopen = async function() {  
                    Connections.RS485 = true
                    await reviewConnections(Connections)
                    ws_rs485.send(JSON.stringify({            
                        client:'dashboard',
                        page:'analytics'
                    }));
                   };
                    
                   ws_rs485.onmessage = async function (evt) { 
                    let received_msg = JSON.parse(evt.data);                    
                    if(received_msg.csv_data){                           
                        if(received_msg.csv_data == 'finished'){                            
                            const base64Datars485 = received_chunks_rs485.join();                            
                            const binaryDatars485 = atob(base64Datars485);                            
                            try {
                                const blobRs232 = new Blob([binaryDatars485], { type: 'application/csv' });
                                const downloadLink = document.createElement('a');
                                downloadLink.href = URL.createObjectURL(blobRs232);
                                downloadLink.download = 'your_data.csv';
                                downloadLink.click();
                            } catch (error) {
                                console.error('Download error:', error);
                            }                            
                        }else{
                            received_chunks_rs485.push(received_msg.csv_data);
                        }
                     }
                    if(received_msg.rs485_plot){
                        var xValues =    Object.keys(received_msg.rs485_plot);
                        var yValues =  Object.keys(received_msg.rs485_plot).map(key => received_msg.rs485_plot[key]); 
                        new Chart("rs485Canvas", {
                            type: "line",
                            data: {
                              labels: xValues,
                              datasets: [{
                                fill: false,
                                lineTension: 0,
                                backgroundColor: "rgba(0,0,255,1.0)",
                                borderColor: "rgba(0,0,255,0.1)",
                                data: yValues
                              }]
                            },
                            options: {
                              legend: {display: false},
                              scales: {
                                //yAxes: [{ticks: {min: -1, max:1}}],
                              }
                            }
                          });
                     }
                    if (received_msg.client == 'producer' && received_msg.action == 'stream' && received_msg.mode == 'serial_rs485'){
                       let rs485_rtc = received_msg.data.RTC
                       let rs485_humidity_val = received_msg.data.AvgeHum
                       let rs485_speed_val = received_msg.data.AvgeSpeed
                       let rs485_sr_val = received_msg.data.AvgeSr
                       let rs485_temp_val = received_msg.data.AvgeTemp

                       rs485_rtc_el.textContent = rs485_rtc
                       rs485_humidity_val_el.textContent = rs485_humidity_val
                       rs485_speed_val_el.textContent = rs485_speed_val
                       rs485_sr_val_el.textContent = rs485_sr_val
                       rs485_temp_val_el.textContent = rs485_temp_val

                       rs485_humidity_progress_el.style.width = `${(rs485_humidity_val + 1) * 50}%`
                       rs485_speed_progress_el.style.width = `${(rs485_speed_val + 1) * 50}%`
                       rs485_sr_progress_el.style.width = `${(rs485_sr_val + 1) * 50}%`
                       rs485_temp_progress_el.style.width = `${(rs485_temp_val + 1) * 50}%`

                    }
                   };
                    
                   ws_rs485.onclose = async function() {
                     Connections.RS485 = false
                     await reviewConnections()
                     console.log("Connection Closed")                     
                   };
                } else {                  
                   alert("WebSocket NOT supported by your Browser!");
                }
             }
         </script>
    </div>

    <!-- Content Row -->
    
        <!-- RS232 -->
        {% include "dashboard/analytics/rs232.html" %}
        
        <!-- RS485 -->
        {% include "dashboard/analytics/rs485.html" %}

        <!-- Pie Chart -->
        <div class="col-xl-12 col-lg-12">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Cloud</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                            aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Dropdown Header:</div>
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle text-primary"></i> Direct
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-success"></i> Social
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-info"></i> Referral
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>    

</div>
<script>
    window.onload = () => {
        WebSocketTestRS232();
        WebSocketTestRS485();
    };    
</script>
{% endblock content %}